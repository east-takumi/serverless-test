name: Step Functions Local Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Set up Node.js for SAM CLI
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install AWS CLI
      run: |
        # Check if AWS CLI is already installed
        if ! command -v aws &> /dev/null; then
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install
        else
          echo "AWS CLI already installed, updating..."
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update
        fi
        aws --version
        
    - name: Install SAM CLI
      run: |
        # Check if SAM CLI is already installed
        if ! command -v sam &> /dev/null; then
          wget https://github.com/aws/aws-sam-cli/releases/latest/download/aws-sam-cli-linux-x86_64.zip
          unzip aws-sam-cli-linux-x86_64.zip -d sam-installation
          sudo ./sam-installation/install
        else
          echo "SAM CLI already installed, updating..."
          wget https://github.com/aws/aws-sam-cli/releases/latest/download/aws-sam-cli-linux-x86_64.zip
          unzip aws-sam-cli-linux-x86_64.zip -d sam-installation
          sudo ./sam-installation/install --update
        fi
        sam --version
        
    - name: Setup Step Functions Local with Docker
      run: |
        # Pull the official AWS Step Functions Local Docker image
        docker pull amazon/aws-stepfunctions-local:latest
        
        # Verify Docker image is available
        docker images amazon/aws-stepfunctions-local
        
    - name: Configure AWS credentials (dummy for local testing)
      run: |
        aws configure set aws_access_key_id dummy
        aws configure set aws_secret_access_key dummy
        aws configure set default.region us-east-1
        aws configure set default.output json     
   
    - name: Start Step Functions Local
      run: |
        # Start Step Functions Local using Docker in background
        # Use host networking for better compatibility in GitHub Actions
        docker run -d \
          --name stepfunctions-local \
          --network host \
          -e LAMBDA_ENDPOINT=http://localhost:3001 \
          amazon/aws-stepfunctions-local:latest
        
        # Wait for Step Functions Local to start
        sleep 15
        
        # Verify Step Functions Local is running
        curl -f http://localhost:8083/ || (echo "Step Functions Local failed to start" && exit 1)
        
    - name: Build and deploy SAM application locally
      run: |
        # Build SAM application
        sam build
        
        # Start SAM local API in background for Lambda functions
        sam local start-api --port 3001 &
        echo $! > sam-api.pid
        
        # Wait for SAM local API to start
        sleep 15
        
        # Verify SAM local API is running
        curl -f http://localhost:3001/ || echo "SAM API started"
        
    - name: Create Step Functions state machine
      run: |
        # Create the state machine using Python script
        python scripts/create_state_machine.py
        
    - name: Run integration tests
      run: |
        # Set environment variables for tests
        export STEPFUNCTIONS_ENDPOINT=http://localhost:8083
        export STATE_MACHINE_ARN=$(cat state_machine_arn.txt)
        
        # Run the integration test suite
        python tests/integration_test.py --config tests/test_config.json --output integration_test_report.json --verbose
        
    - name: Run unit tests with pytest
      run: |
        # Set environment variables for tests
        export STEPFUNCTIONS_ENDPOINT=http://localhost:8083
        export STATE_MACHINE_ARN=$(cat state_machine_arn.txt)
        
        # Run pytest with JUnit XML output
        python -m pytest tests/ -v --tb=short --junit-xml=test-results.xml
        
    - name: Generate comprehensive test report
      if: always()
      run: |
        python scripts/generate_test_report.py
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          test-results.xml
          integration_test_report.json
          comprehensive_test_report.json
          *.log
          
    - name: Cleanup processes
      if: always()
      run: |
        # Stop Step Functions Local Docker container
        docker stop stepfunctions-local || true
        docker rm stepfunctions-local || true
        
        # Stop SAM local API
        if [ -f sam-api.pid ]; then
          kill $(cat sam-api.pid) || true
        fi
        
        # Clean up any remaining processes
        pkill -f "sam local start-api" || true